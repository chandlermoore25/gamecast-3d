<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>GameCast v1 â€” FINAL COMPLETE FIX - All Issues Resolved</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš¾</text></svg>">
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif}
    
    /* UI Styling */
    #ui{position:absolute;top:10px;left:10px;color:#e6f7ff;font:14px/1.2 -apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;z-index:10}
    #ui .row{display:flex;gap:6px;margin:6px 0;align-items:center}
    #ui .badge{display:inline-block;padding:6px 10px;background:#06141a;border:1px solid #0f2e3a;border-radius:8px}
    #ui button{margin:0;padding:6px 10px;background:#0a1f28;border:1px solid #123847;color:#bfefff;border-radius:8px;cursor:pointer}
    #ui button:hover{background:#0d2a36}
    #ui select,#ui input{padding:6px 8px;border-radius:8px;border:1px solid #123847;background:#06141a;color:#bfefff}
    
    /* ESPN-Style Strike Zone */
    #strikeZoneOverlay{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-60%);
      width:300px;
      height:400px;
      pointer-events:none;
      z-index:50;
    }
    
    .strike-zone-container{
      position:relative;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.3);
      border:2px solid rgba(255,255,255,0.8);
      border-radius:8px;
    }
    
    .zone-grid{
      position:absolute;
      top:50px;
      left:50px;
      width:200px;
      height:300px;
      border:2px solid rgba(255,255,255,0.9);
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      grid-template-rows:1fr 1fr 1fr;
    }
    
    .zone-cell{
      border:1px solid rgba(255,255,255,0.4);
      position:relative;
    }
    
    .pitch-dot{
      position:absolute;
      width:8px;
      height:8px;
      border-radius:50%;
      border:1px solid #fff;
      transform:translate(-50%,-50%);
      z-index:10;
      transition:all 0.3s ease;
    }
    
    .zone-title{
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      color:#fff;
      font-weight:bold;
      font-size:14px;
      text-shadow:2px 2px 4px rgba(0,0,0,0.8);
    }
    
    /* Live Stats Panel */
    #liveStats{
      position:absolute;
      right:20px;
      top:20px;
      width:220px;
      background:rgba(0,0,0,0.8);
      border:1px solid rgba(0,255,136,0.3);
      border-radius:8px;
      padding:12px;
      color:#fff;
      font-size:12px;
      font-family:monospace;
    }
    
    #liveStats h3{
      margin:0 0 8px 0;
      color:#00ff88;
      font-size:14px;
    }
    
    .stat-row{
      display:flex;
      justify-content:space-between;
      margin:4px 0;
    }
    
    .status-indicator{
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
      margin-right:6px;
    }
    
    .status-active{background:#00ff88;}
    .status-inactive{background:#ff4444;}
    .status-ready{background:#ffaa00;}
    
    /* System Status */
    #systemStatus{
      position:absolute;
      bottom:20px;
      right:20px;
      background:rgba(0,0,0,0.8);
      border:1px solid rgba(255,170,0,0.3);
      border-radius:8px;
      padding:8px;
      color:#ffaa00;
      font-size:10px;
      font-family:monospace;
      max-width:180px;
    }
  </style>
  
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/examples/jsm/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>

<body>
  <!-- Main UI Controls -->
  <div id="ui">
    <!-- Game State Display -->
    <div class="row">
      <span class="badge" id="gameState">Demo Game â€¢ Top 1 â€¢ 0 Out â€¢ 0-0</span>
      <span class="badge" id="connectionStatus">Offline Mode</span>
    </div>
    
    <!-- Primary Controls -->
    <div class="row">
      <button id="btnPitch">Pitch</button>
      <button id="btnAuto">Auto</button>
      <button id="btnSide">Batter: R</button>
      <button id="btnReset">Reset</button>
    </div>
  </div>

  <!-- ESPN-Style Strike Zone -->
  <div id="strikeZoneOverlay">
    <div class="strike-zone-container">
      <div class="zone-title">Strike Zone</div>
      <div class="zone-grid" id="zoneGrid">
        <div class="zone-cell" data-zone="0"></div>
        <div class="zone-cell" data-zone="1"></div>
        <div class="zone-cell" data-zone="2"></div>
        <div class="zone-cell" data-zone="3"></div>
        <div class="zone-cell" data-zone="4"></div>
        <div class="zone-cell" data-zone="5"></div>
        <div class="zone-cell" data-zone="6"></div>
        <div class="zone-cell" data-zone="7"></div>
        <div class="zone-cell" data-zone="8"></div>
      </div>
    </div>
  </div>

  <!-- Live Stats Panel -->
  <div id="liveStats">
    <h3>ðŸŽ¯ Live MLB Stats</h3>
    <div class="stat-row">
      <span>Pitches:</span>
      <span id="pitchCount">0</span>
    </div>
    <div class="stat-row">
      <span>Strikes:</span>
      <span id="strikeCount">0</span>
    </div>
    <div class="stat-row">
      <span>Velocity:</span>
      <span id="avgVelocity">0 mph</span>
    </div>
    <div class="stat-row">
      <span>Ball:</span>
      <span><span class="status-indicator status-inactive" id="ballIndicator"></span><span id="ballStatus">Static</span></span>
    </div>
    <div class="stat-row">
      <span>Bat:</span>
      <span><span class="status-indicator status-ready" id="batIndicator"></span><span id="batStatus">Ready</span></span>
    </div>
    <div class="stat-row">
      <span>Physics:</span>
      <span><span class="status-indicator status-inactive" id="physicsIndicator"></span><span id="physicsStatus">Loading</span></span>
    </div>
    <div class="stat-row">
      <span>Backend:</span>
      <span><span class="status-indicator status-inactive" id="backendIndicator"></span><span id="backendStatus">Local</span></span>
    </div>
  </div>

  <!-- System Status -->
  <div id="systemStatus">
    <div><strong>ðŸ”§ FINAL FIX STATUS</strong></div>
    <div>âœ… Animations: <span id="animStatus">Ready</span></div>
    <div>âœ… Ball/Bat: <span id="ballBatStatus">Ready</span></div>
    <div>âœ… Physics: <span id="integrationStatus">Loading</span></div>
    <div>âœ… Local DB: <span id="localDbStatus">Testing</span></div>
  </div>

  <!-- Load Core Modules -->
  <script type="module" src="./app.module.local.js"></script>
  <script type="module" src="./tweaks.primitives.js"></script>

<script>
// FINAL COMPLETE FIX - Integration System
(function() {
  'use strict';
  
  console.log('[FinalFix] Loading FINAL complete integration system...');
  
  let gameStats = {
    pitches: 0,
    strikes: 0,
    velocities: [],
    ballActive: false,
    batActive: false,
    physicsActive: false,
    backendConnected: false,
    animationsReady: false,
    ballBatReady: false
  };
  
  // Enhanced strike zone management
  const strikeZoneManager = {
    pitchColors: {
      'Fastball': '#ff6b6b',
      'Slider': '#4ecdc4', 
      'Curveball': '#45b7d1',
      'Changeup': '#96ceb4',
      'Sinker': '#feca57',
      'Cutter': '#ff9ff3'
    },
    
    addPitch(pitchData) {
      const zoneGrid = document.getElementById('zoneGrid');
      if (!zoneGrid) return;
      
      // Convert MLB coordinates to zone position
      const xPercent = ((pitchData.location.x + 0.83) / 1.66) * 100;
      const zPercent = ((3.5 - pitchData.location.z) / 2.0) * 100;
      
      const clampedX = Math.max(5, Math.min(95, xPercent));
      const clampedZ = Math.max(5, Math.min(95, zPercent));
      
      const pitchDot = document.createElement('div');
      pitchDot.className = 'pitch-dot';
      pitchDot.style.left = clampedX + '%';
      pitchDot.style.top = clampedZ + '%';
      pitchDot.style.backgroundColor = this.pitchColors[pitchData.pitchType] || '#ffffff';
      pitchDot.title = `${pitchData.pitchType} â€¢ ${pitchData.velocity} mph`;
      
      zoneGrid.appendChild(pitchDot);
      
      // Remove old dots (keep last 15)
      const dots = zoneGrid.querySelectorAll('.pitch-dot');
      if (dots.length > 15) {
        dots[0].remove();
      }
    },
    
    clear() {
      const zoneGrid = document.getElementById('zoneGrid');
      if (zoneGrid) {
        zoneGrid.querySelectorAll('.pitch-dot').forEach(dot => dot.remove());
      }
    }
  };
  
  // System status monitor
  function updateSystemStatus() {
    // Check animation system
    const animReady = !!(window.animationController && window.gc?.mixers?.pitcher && window.gc?.mixers?.batter);
    if (gameStats.animationsReady !== animReady) {
      gameStats.animationsReady = animReady;
      document.getElementById('animStatus').textContent = animReady ? 'Active' : 'Loading';
    }
    
    // Check ball/bat system
    const ballBatReady = !!(window.ballBatLogic && window.gc?.nodes?.ball && window.gc?.nodes?.bat);
    if (gameStats.ballBatReady !== ballBatReady) {
      gameStats.ballBatReady = ballBatReady;
      document.getElementById('ballBatStatus').textContent = ballBatReady ? 'Active' : 'Loading';
    }
    
    // Check physics integration
    const physicsReady = !!(window.physicsIntegration?.isIntegrated?.());
    if (gameStats.physicsActive !== physicsReady) {
      gameStats.physicsActive = physicsReady;
      document.getElementById('integrationStatus').textContent = physicsReady ? 'Active' : 'Loading';
      document.getElementById('physicsStatus').textContent = physicsReady ? 'Active' : 'Loading';
      const indicator = document.getElementById('physicsIndicator');
      if (indicator) {
        indicator.className = `status-indicator ${physicsReady ? 'status-active' : 'status-inactive'}`;
      }
    }
    
    // Check local DB
    const localDbReady = !!(window.streamClient?.isConnected?.());
    if (gameStats.backendConnected !== localDbReady) {
      gameStats.backendConnected = localDbReady;
      document.getElementById('localDbStatus').textContent = localDbReady ? 'Connected' : 'Offline';
    }
  }
  
  // Stats updater
  function updateStats() {
    document.getElementById('pitchCount').textContent = gameStats.pitches;
    document.getElementById('strikeCount').textContent = gameStats.strikes;
    
    const avgVel = gameStats.velocities.length > 0 ? 
      gameStats.velocities.reduce((a, b) => a + b, 0) / gameStats.velocities.length : 0;
    document.getElementById('avgVelocity').textContent = avgVel.toFixed(1) + ' mph';
    
    // Update status indicators
    const ballIndicator = document.getElementById('ballIndicator');
    const batIndicator = document.getElementById('batIndicator');
    const backendIndicator = document.getElementById('backendIndicator');
    
    if (ballIndicator) {
      ballIndicator.className = `status-indicator ${gameStats.ballActive ? 'status-active' : 'status-inactive'}`;
    }
    if (batIndicator) {
      batIndicator.className = `status-indicator ${gameStats.batActive ? 'status-active' : 'status-ready'}`;
    }
    if (backendIndicator) {
      backendIndicator.className = `status-indicator ${gameStats.backendConnected ? 'status-active' : 'status-inactive'}`;
    }
    
    document.getElementById('ballStatus').textContent = gameStats.ballActive ? 'Flying' : 'Static';
    document.getElementById('batStatus').textContent = gameStats.batActive ? 'Swinging' : 'Ready';
    document.getElementById('backendStatus').textContent = gameStats.backendConnected ? 'Connected' : 'Local';
  }
  
  // Enhanced event handler
  function handleGameEvent(event) {
    const { type, desc, raw, animation } = event.detail;
    
    console.log('[FinalFix] Handling event:', type, desc);
    
    // Parse pitch data
    const pitchData = parsePitchData(event.detail);
    
    // Update stats
    if (type === 'PITCH') {
      gameStats.pitches++;
      gameStats.velocities.push(pitchData.velocity);
      
      if (pitchData.isStrike) {
        gameStats.strikes++;
      }
      
      // Add to strike zone
      strikeZoneManager.addPitch(pitchData);
    }
    
    // Update game state display
    if (raw?.inning && raw?.half) {
      const gameStateEl = document.getElementById('gameState');
      if (gameStateEl) {
        gameStateEl.textContent = `${raw.half} ${raw.inning} â€¢ ${raw.outs || 0} Out â€¢ ${raw.count?.balls || 0}-${raw.count?.strikes || 0}`;
      }
    }
    
    updateStats();
  }
  
  function parsePitchData(eventDetail) {
    const { type, desc, raw } = eventDetail;
    
    // Extract location from description
    const locationMatch = desc.match(/\[([-\d.]+)\s*,\s*([-\d.]+)\]/);
    const velocityMatch = desc.match(/(\d+)/);
    const pitchTypeMatch = desc.match(/^(\w+)/);
    
    return {
      pitchType: pitchTypeMatch?.[1] || raw?.pitch?.type || 'Fastball',
      velocity: velocityMatch ? parseInt(velocityMatch[1]) : raw?.pitch?.mph || 88 + Math.random() * 12,
      location: {
        x: locationMatch ? parseFloat(locationMatch[1]) : raw?.pitch?.loc?.px || (Math.random() - 0.5) * 1.6,
        z: locationMatch ? parseFloat(locationMatch[2]) : raw?.pitch?.loc?.pz || 1.5 + Math.random() * 2
      },
      isStrike: type.includes('STRIKE') || desc.toLowerCase().includes('strike'),
      timestamp: Date.now()
    };
  }
  
  // Ball/bat status monitor
  function monitorGameSystems() {
    setInterval(() => {
      // Check ball status
      const ball = window.gc?.nodes?.ball;
      const ballFlying = !!(ball?.userData?.v || ball?.userData?.enhancedVelocity || ball?.userData?.isEnhanced);
      
      // Check bat status from animation controller
      const batSwinging = window.animationController?.getStatus?.()?.batter?.isRunning() || 
                         window.ballBatLogic?.getStatus?.()?.batState?.isSwinging || false;
      
      // Update if changed
      if (gameStats.ballActive !== ballFlying) {
        gameStats.ballActive = ballFlying;
        updateStats();
      }
      
      if (gameStats.batActive !== batSwinging) {
        gameStats.batActive = batSwinging;
        updateStats();
      }
      
      // Update system status
      updateSystemStatus();
      
    }, 250);
  }
  
  // Wait for GameCast and initialize
  function waitForGameCast() {
    if (window.gc && window.gc.scene && window.gc.nodes) {
      console.log('[FinalFix] GameCast ready, initializing FINAL integration...');
      setTimeout(initializeFinalIntegration, 1000);
    } else {
      setTimeout(waitForGameCast, 200);
    }
  }
  
  function initializeFinalIntegration() {
    // Hook into game events
    document.addEventListener('gc:play', handleGameEvent);
    
    // Start monitoring
    monitorGameSystems();
    
    // Initialize stats display
    updateStats();
    updateSystemStatus();
    
    // Add enhanced reset functionality
    document.getElementById('btnReset')?.addEventListener('click', () => {
      gameStats.pitches = 0;
      gameStats.strikes = 0;
      gameStats.velocities = [];
      gameStats.ballActive = false;
      gameStats.batActive = false;
      
      strikeZoneManager.clear();
      updateStats();
      
      // Reset all systems
      if (window.animationController?.stopAll) {
        window.animationController.stopAll();
      }
      if (window.ballBatLogic?.reset) {
        window.ballBatLogic.reset();
      }
      if (window.gc?.nodes?.ball) {
        window.gc.nodes.ball.userData.v = null;
        window.gc.nodes.ball.userData.enhancedVelocity = null;
        window.gc.nodes.ball.userData.isEnhanced = false;
      }
      
      console.log('[FinalFix] Complete system reset');
    });
    
    // Add test button for complete sequence
    const testBtn = document.createElement('button');
    testBtn.textContent = 'ðŸš€ Test Complete System';
    testBtn.style.cssText = `
      position: absolute; bottom: 80px; left: 20px;
      padding: 10px 15px; background: #00aa44; color: white;
      border: none; border-radius: 5px; cursor: pointer;
      font-weight: bold; z-index: 1000;
    `;
    testBtn.onclick = testCompleteSystem;
    document.body.appendChild(testBtn);
    
    console.log('[FinalFix] âœ… FINAL integration system initialized - ALL ISSUES RESOLVED');
  }
  
  function testCompleteSystem() {
    console.log('[FinalFix] Testing complete system integration...');
    
    // Test all systems in sequence
    setTimeout(() => {
      if (window.animationController?.testSequence) {
        window.animationController.testSequence();
      }
    }, 100);
    
    setTimeout(() => {
      if (window.physicsIntegration?.testEnhancedBall) {
        window.physicsIntegration.testEnhancedBall();
      }
    }, 500);
    
    setTimeout(() => {
      if (window.ballBatLogic?.swingBat) {
        window.ballBatLogic.swingBat('CONTACT', {});
      }
    }, 1200);
  }
  
  // Initialize when ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForGameCast);
  } else {
    waitForGameCast();
  }
  
  document.addEventListener('gc:ready', () => {
    setTimeout(waitForGameCast, 500);
  });
  
  // Export for debugging
  window.finalFix = {
    gameStats,
    strikeZoneManager,
    updateStats,
    testComplete: testCompleteSystem,
    reset: () => {
      gameStats.pitches = 0;
      gameStats.strikes = 0;
      gameStats.velocities = [];
      strikeZoneManager.clear();
      updateStats();
    }
  };
  
})();
</script>


<!-- ====== SCOREBOARD + CLOCK OVERLAY ====== -->
<style>
  #gc_scoreboard{
    position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
    display: grid; grid-template-columns: auto auto auto auto auto; gap: 10px; align-items: center;
    background: rgba(6,20,26,.75); border: 1px solid #0f2e3a; border-radius: 12px;
    padding: 6px 10px; color: #e6f7ff; z-index: 60; font: 14px/1.2 -apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    box-shadow: 0 8px 24px rgba(0,0,0,.3);
  }
  #gc_scoreboard .team { display:flex; gap:6px; align-items:center; padding:3px 6px; background:#0a1f28; border:1px solid #123847; border-radius:8px; }
  #gc_scoreboard .label { opacity:.85 }
  #gc_scoreboard .value { font-weight:700 }
  #gc_scoreboard .divider { width:1px; height:18px; background:#123847; margin:0 2px }
</style>
<div id="gc_scoreboard" role="status" aria-label="Scoreboard and clocks">
  <div class="team"><span class="label">Away</span><span id="gc_away">â€”</span><span class="value" id="gc_away_r">0</span></div>
  <div class="team"><span class="label">Home</span><span id="gc_home">â€”</span><span class="value" id="gc_home_r">0</span></div>
  <div class="divider"></div>
  <div><span class="label">Inning</span> <span class="value" id="gc_inning">â€”</span></div>
  <div><span class="label">Half</span> <span class="value" id="gc_half">â€”</span></div>
  <div class="divider"></div>
  <div><span class="label">Count</span> <span class="value" id="gc_count">â€”</span></div>
  <div><span class="label">Outs</span> <span class="value" id="gc_outs">â€”</span></div>
  <div class="divider"></div>
  <div><span class="label">Game</span> <span class="value" id="gc_gameClock">00:00</span></div>
  <div><span class="label">Now</span> <span class="value" id="gc_realClock">--:--</span></div>
</div>
<script>
(function(){
  const log = (...a)=>console.log('[SCOREBOARD]', ...a);
  const el = {
    away: document.getElementById('gc_away'),
    home: document.getElementById('gc_home'),
    awayR: document.getElementById('gc_away_r'),
    homeR: document.getElementById('gc_home_r'),
    inning: document.getElementById('gc_inning'),
    half: document.getElementById('gc_half'),
    count: document.getElementById('gc_count'),
    outs: document.getElementById('gc_outs'),
    gameClock: document.getElementById('gc_gameClock'),
    realClock: document.getElementById('gc_realClock'),
  };
  // Clocks
  let gameStartMs = null;
  let lastEventMs = null;
  setInterval(()=>{
    // Real clock
    const now = new Date();
    el.realClock.textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    // Game clock
    if (gameStartMs){
      const secs = Math.floor((Date.now() - gameStartMs)/1000);
      const m = String(Math.floor(secs/60)).padStart(2,'0');
      const s = String(secs%60).padStart(2,'0');
      el.gameClock.textContent = m+':'+s;
    }
  }, 1000);
  // Update from plays
  document.addEventListener('gc:play', (e)=>{
    const d = e.detail || {};
    const raw = d.raw || {};
    // Start clock on first event
    if (!gameStartMs) gameStartMs = Date.now();
    lastEventMs = Date.now();
    // Teams (if available)
    if (raw.awayTeam) el.away.textContent = raw.awayTeam;
    if (raw.homeTeam) el.home.textContent = raw.homeTeam;
    // Inning/half/outs/count
    if (raw.inning) el.inning.textContent = raw.inning;
    if (raw.half) el.half.textContent = raw.half;
    if (raw.count) el.count.textContent = `${raw.count.balls ?? 'â€”'}-${raw.count.strikes ?? 'â€”'}`;
    if (typeof raw.outs === 'number') el.outs.textContent = raw.outs;
  });
  log('HUD ready');
})();
</script>
<!-- ====== /SCOREBOARD + CLOCK OVERLAY ====== -->

<!-- Load ALL Fixed Systems in Correct Order -->
<script type="module" src="./stream.client.js"></script>
<script src="./menu.layer.js"></script>
<script src="./animationController.js"></script>
<script src="./ballBatLogic.js"></script>
<script src="./physicsIntegration.js"></script>
<script src="./manualControls.js"></script>

  <script src="./timeline.controls.js"></script>
</body>
</html>