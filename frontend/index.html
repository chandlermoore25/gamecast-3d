<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>GameCast 3D - Clean System</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öæ</text></svg>">
  
  <style>
    html, body { margin: 0; height: 100%; background: #000; overflow: hidden; }
    
    /* ========================================
       MODE SELECTOR OVERLAY
    ======================================== */
    #modeSelector {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a1a2e 0%, #16213e 50%, #1a3a4a 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.5s ease;
    }
    
    #modeSelector.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .logo {
      font-size: 4rem;
      font-weight: 900;
      background: linear-gradient(45deg, #00d4ff, #0099cc, #ffffff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
      text-align: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }
    
    .subtitle {
      font-size: 1.2rem;
      color: #99ccdd;
      margin-bottom: 3rem;
      text-align: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }
    
    .mode-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      max-width: 1200px;
      width: 100%;
      padding: 0 2rem;
    }
    
    .mode-card {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(0, 150, 200, 0.3);
      border-radius: 15px;
      padding: 2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      text-align: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }
    
    .mode-card:hover {
      border-color: #00d4ff;
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
    }
    
    .mode-card h3 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: #00d4ff;
    }
    
    .mode-card p {
      color: #b3d9e6;
      line-height: 1.5;
    }
    
    /* ========================================
       UNIFIED UI SYSTEM (No Duplicates)
    ======================================== */
    #gameUI {
      position: fixed;
      top: 10px;
      left: 10px;
      color: #e6f7ff;
      font: 14px/1.2 -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      z-index: 100;
      display: none;
    }
    
    #gameUI .ui-row {
      display: flex;
      gap: 6px;
      margin: 6px 0;
      align-items: center;
    }
    
    #gameUI .badge {
      display: inline-block;
      padding: 6px 10px;
      background: #06141a;
      border: 1px solid #0f2e3a;
      border-radius: 8px;
    }
    
    #gameUI button {
      margin: 0;
      padding: 6px 10px;
      background: #0a1f28;
      border: 1px solid #123847;
      color: #bfefff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
    }
    
    #gameUI button:hover {
      background: #0d2a36;
    }
    
    #gameUI button.primary {
      background: #1a4a2e;
      border-color: #16421b;
    }
    
    #gameUI button.danger {
      background: #5a1a1a;
      border-color: #4a1515;
    }
    
    #gameUI .input-field {
      padding: 4px 8px;
      border: 1px solid #123847;
      border-radius: 4px;
      background: #06141a;
      color: #bfefff;
      font-size: 12px;
    }
    
    /* ========================================
       DEBUG PANEL
    ======================================== */
    #debugPanel {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 280px;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      color: #00ff00;
      font: 11px/1.3 'Courier New', monospace;
      z-index: 100;
      max-height: 400px;
      overflow-y: auto;
      display: none;
    }
    
    #debugPanel h4 {
      margin: 0 0 8px 0;
      color: #00d4ff;
      font-size: 12px;
    }
    
    .debug-row {
      display: flex;
      justify-content: space-between;
      margin: 2px 0;
      padding: 1px 0;
    }
    
    .debug-row.error { color: #ff4444; }
    .debug-row.success { color: #44ff44; }
    .debug-row.warning { color: #ffaa44; }
    
    /* ========================================
       STATUS HUD (Bottom Right)
    ======================================== */
    #statusHUD {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px;
      color: #00ff00;
      font: 11px/1.3 'Courier New', monospace;
      z-index: 100;
      min-width: 200px;
    }
    
    .status-title {
      color: #00d4ff;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      margin: 2px 0;
    }
    
    /* ========================================
       RESPONSIVE
    ======================================== */
    @media (max-width: 768px) {
      .mode-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .logo {
        font-size: 2.5rem;
      }
      
      #debugPanel, #statusHUD {
        width: 200px;
        font-size: 10px;
      }
    }
  </style>
  
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/examples/jsm/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <!-- ========================================
       MODE SELECTOR
  ======================================== -->
  <div id="modeSelector">
    <div class="logo">GameCast 3D</div>
    <div class="subtitle">Ultimate Baseball Simulation Experience</div>
    
    <div class="mode-grid">
      <div class="mode-card" data-mode="demo">
        <h3>üé¨ Demo Mode</h3>
        <p>Experience automated gameplay with realistic ball physics, animations, and strike zone visualization.</p>
      </div>
      
      <div class="mode-card" data-mode="live">
        <h3>üî¥ Live Mode</h3>
        <p>Connect to your gamecast-3d.onrender.com backend for real-time MLB data integration.</p>
      </div>
      
      <div class="mode-card" data-mode="sandbox">
        <h3>üõ†Ô∏è Sandbox Mode</h3>
        <p>Manual controls for testing animations, physics, and ball-bat collision systems.</p>
      </div>
      
      <div class="mode-card" data-mode="classic">
        <h3>‚öæ Classic Mode</h3>
        <p>Your original working system exactly as it is - clean and functional.</p>
      </div>
    </div>
  </div>
  
  <!-- ========================================
       UNIFIED GAME UI (No Duplicates)
  ======================================== -->
  <div id="gameUI">
    <!-- Navigation Bar -->
    <div class="ui-row">
      <span class="badge" id="currentMode">Demo Mode</span>
      <button id="backToMenu">üè† Menu</button>
      <button id="toggleDebug">üêõ Debug</button>
      <span class="badge" id="systemStatus">Ready</span>
    </div>
    
    <!-- Mode-Specific Controls (Only one set) -->
    <div class="ui-row" id="modeControls">
      <!-- Controls will be dynamically populated based on mode -->
    </div>
    
    <!-- Backend Controls (Live Mode Only) -->
    <div class="ui-row" id="backendControls" style="display: none;">
      <input id="api" type="text" value="https://gamecast-3d.onrender.com" class="input-field" style="width:170px;" />
      <input id="date" type="date" class="input-field" />
      <button id="load">Load Games</button>
      <select id="games" class="input-field" style="min-width:200px;"></select>
      <button id="connect">Connect</button>
      <span class="badge" id="connectionStatus">Disconnected</span>
    </div>
  </div>
  
  <!-- ========================================
       DEBUG PANEL
  ======================================== -->
  <div id="debugPanel">
    <h4>üêõ System Debug Panel</h4>
    <div id="debugContent">
      <!-- Debug info will be populated here -->
    </div>
    <div style="margin-top: 10px; border-top: 1px solid #333; padding-top: 5px;">
      <button onclick="window.gameController?.debugAll()" style="background: #333; color: #0f0; border: 1px solid #666; padding: 3px 8px; border-radius: 3px; cursor: pointer;">Refresh</button>
    </div>
  </div>
  
  <!-- ========================================
       STATUS HUD
  ======================================== -->
  <div id="statusHUD">
    <div class="status-title">System Status</div>
    <div class="status-item">
      <span>Controller:</span>
      <span id="controllerStatus">Loading</span>
    </div>
    <div class="status-item">
      <span>Ball:</span>
      <span id="ballStatus">Static</span>
    </div>
    <div class="status-item">
      <span>Execution:</span>
      <span id="executionStatus">Ready</span>
    </div>
    <div class="status-item">
      <span>Mode:</span>
      <span id="modeStatus">Menu</span>
    </div>
  </div>

  <!-- Original strike zone canvas -->
  <canvas id="zoneCanvas" width="360" height="360" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-45%);width:28vmin;height:28vmin;pointer-events:none;opacity:.96"></canvas>

  <!-- ========================================
       LOAD CORE MODULES
  ======================================== -->
  <script>
    // Early gc stub
    window.gc = window.gc || {};
    window.gc.anchors = window.gc.anchors || {};
    window.gc.nodes = window.gc.nodes || {};
    window.gc.state = window.gc.state || { batterHand: 'R' };
  </script>
  
  <script type="module" src="./app.module.local.js"></script>
  <script type="module" src="./tweaks.primitives.js"></script>
  <script type="module" src="./stream.client.js"></script>

  <!-- ========================================
       CLEAN UNIFIED GAME CONTROLLER
  ======================================== -->
  <script>
    (function() {
      'use strict';
      
      console.log('[CleanGameController] Starting clean unified system...');
      
      class CleanGameController {
        constructor() {
          this.currentMode = null;
          this.isReady = false;
          this.debug = { enabled: false, logs: [], maxLogs: 50 };
          
          // FIXED: Execution tracking to prevent duplicates
          this.execution = {
            isProcessing: false,
            lastAction: null,
            lastTime: 0,
            cooldownPeriod: 1000 // 1 second cooldown between actions
          };
          
          // Demo data
          this.demoData = [
            { type: 'PITCH', desc: 'FB 94 [0.2,2.8]', shouldSwing: false },
            { type: 'PITCH', desc: 'SL 87 [-0.4,2.1]', shouldSwing: false },
            { type: 'PITCH', desc: 'FB 95 [0.1,2.5]', shouldSwing: true },
            { type: 'PITCH', desc: 'CH 85 [0.0,2.3]', shouldSwing: true },
            { type: 'PITCH', desc: 'CB 79 [0.3,1.7]', shouldSwing: false },
            { type: 'PITCH', desc: 'FB 98 [0.0,2.6]', shouldSwing: true }
          ];
          this.demoIndex = 0;
          this.demoInterval = null;
          
          this.systems = { 
            gamecast: false, 
            streamClient: false, 
            ballPhysics: false, 
            heatMap: false 
          };
          
          this.init();
        }
        
        init() {
          this.debugLog('Initializing clean unified controller...');
          this.waitForCore();
        }
        
        waitForCore() {
          // Listen for GameCast ready event
          document.addEventListener('gc:ready', () => {
            this.debugLog('üéØ GameCast ready event received!', 'success');
            setTimeout(() => {
              this.checkGameCastAndProceed();
            }, 500);
          });
          
          // Polling backup
          const checkInterval = setInterval(() => {
            const gcReady = !!(window.gc && window.gc.scene && (window.play || window.gc.play));
            
            if (gcReady) {
              clearInterval(checkInterval);
              this.checkGameCastAndProceed();
            }
          }, 500);
          
          // Timeout
          setTimeout(() => {
            clearInterval(checkInterval);
            if (!this.isReady) {
              this.debugLog('‚ö†Ô∏è Timeout reached, forcing initialization', 'warning');
              this.forceInitialize();
            }
          }, 15000);
        }
        
        checkGameCastAndProceed() {
          if (this.isReady) return;
          
          const gcReady = !!(window.gc && window.gc.scene && (window.play || window.gc.play));
          
          if (gcReady) {
            this.debugLog('‚úÖ GameCast confirmed ready!', 'success');
            this.systems.gamecast = true;
            this.systems.streamClient = !!(window.streamClient || window.stream);
            
            this.enhanceSystems();
            this.setupUI();
            this.startStatusUpdates();
            this.isReady = true;
            this.debugLog('‚úÖ Clean unified controller ready!', 'success');
          }
        }
        
        enhanceSystems() {
          this.debugLog('Enhancing game systems...');
          
          // Store original functions
          const originalPlay = window.play;
          
          // ENHANCED: Play function with smart duplicate prevention
          window.play = (actionKey, desc) => {
            const now = performance.now();
            const actionId = `${actionKey}-${desc}`;
            
            // ENHANCED: Better duplicate prevention
            if (this.execution.isProcessing) {
              this.debugLog(`‚ö†Ô∏è Skipping - still processing: ${actionKey}`, 'warning');
              return;
            }
            
            if (this.execution.lastAction === actionId && (now - this.execution.lastTime) < this.execution.cooldownPeriod) {
              this.debugLog(`‚ö†Ô∏è Skipping - cooldown active: ${actionKey}`, 'warning');
              return;
            }
            
            this.execution.isProcessing = true;
            this.execution.lastAction = actionId;
            this.execution.lastTime = now;
            
            this.debugLog(`üéØ Executing: ${actionKey} ${desc || ''}`, 'success');
            
            // Call original play
            if (originalPlay) {
              originalPlay(actionKey, desc);
            }
            
            // ENHANCED: Smarter ball physics timing
            if (actionKey === 'PITCH') {
              setTimeout(() => this.ensureBallLaunches(desc), 300);
            }
            
            // ENHANCED: Single heat map update
            setTimeout(() => this.updateHeatMap(actionKey, desc), 150);
            
            // ENHANCED: Proper cooldown reset
            setTimeout(() => {
              this.execution.isProcessing = false;
              this.debugLog(`‚úÖ Action completed: ${actionKey}`);
            }, this.execution.cooldownPeriod);
          };
          
          this.setupHeatMap();
          this.systems.ballPhysics = true;
          this.systems.heatMap = true;
          
          this.debugLog('‚úÖ Systems enhanced successfully', 'success');
        }
        
        ensureBallLaunches(desc) {
          const ball = window.gc?.nodes?.ball;
          if (!ball) {
            this.debugLog('‚ùå No ball found', 'error');
            return;
          }
          
          // ENHANCED: Better ball state management
          if (ball.userData.v && ball.userData.v.length() > 0.01) {
            this.debugLog('‚ö†Ô∏è Ball moving, waiting for stop...', 'warning');
            
            const waitForStop = setInterval(() => {
              if (!ball.userData.v || ball.userData.v.length() <= 0.01) {
                clearInterval(waitForStop);
                this.launchBallNow(desc, ball);
              }
            }, 100);
            
            setTimeout(() => {
              clearInterval(waitForStop);
              if (ball.userData.v) {
                ball.userData.v = null; // Force stop
                this.launchBallNow(desc, ball);
              }
            }, 2000);
            
            return;
          }
          
          this.launchBallNow(desc, ball);
        }
        
        launchBallNow(desc, ball) {
          // Parse pitch data
          const velocityMatch = desc?.match(/(\d+)/);
          const locationMatch = desc?.match(/\[([-\d.]+)\s*,\s*([-\d.]+)\]/);
          
          const velocity = velocityMatch ? parseInt(velocityMatch[1]) : 95;
          const location = locationMatch ? 
            { x: parseFloat(locationMatch[1]), z: parseFloat(locationMatch[2]) } :
            { x: (Math.random() - 0.5) * 1.2, z: 1.8 + Math.random() * 1.2 };
          
          // Position ball at pitcher
          const pitcher = window.gc.nodes.pitcher;
          if (pitcher) {
            ball.position.copy(pitcher.position);
            ball.position.y += 30;
            ball.position.x += 10;
          } else {
            ball.position.set(0, 35, -280);
          }
          
          // Calculate realistic velocity
          const platePos = window.gc.anchors?.plate?.position || new THREE.Vector3(0, 0, -310);
          const target = platePos.clone();
          target.x += location.x * 40;
          target.y = Math.max(10, location.z * 15);
          target.z += 25;
          
          const direction = target.clone().sub(ball.position).normalize();
          const speed = (velocity / 95) * 1.2;
          
          ball.userData.v = direction.multiplyScalar(speed);
          ball.userData.v.y += 0.15;
          
          // Visual enhancements
          ball.visible = true;
          ball.scale.setScalar(3);
          ball.material.emissive.setHex(0x111111);
          
          // Trail system
          if (window.tracerClear) {
            window.tracerClear();
          }
          
          this.debugLog(`‚öæ Ball launched: ${velocity}mph ‚Üí (${location.x.toFixed(2)}, ${location.z.toFixed(2)})`, 'success');
        }
        
        setupHeatMap() {
          if (!window.heat) {
            window.heat = Array(3).fill(null).map(() => Array(3).fill(0));
          }
          
          window.drawZone = () => {
            const canvas = document.getElementById('zoneCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            
            ctx.clearRect(0, 0, w, h);
            
            // Strike zone outline
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.lineWidth = 3;
            ctx.strokeRect(w*0.15, h*0.15, w*0.7, h*0.7);
            
            // Heat map cells
            const cellW = w * 0.7 / 3;
            const cellH = h * 0.7 / 3;
            
            for (let row = 0; row < 3; row++) {
              for (let col = 0; col < 3; col++) {
                const count = window.heat[row][col];
                
                if (count > 0) {
                  const intensity = Math.min(count / 5, 1);
                  const alpha = 0.2 + intensity * 0.6;
                  
                  // Color gradient: blue ‚Üí green ‚Üí yellow ‚Üí red
                  let r, g, b;
                  if (intensity < 0.33) {
                    r = 0;
                    g = intensity * 3 * 255;
                    b = 255;
                  } else if (intensity < 0.66) {
                    r = (intensity - 0.33) * 3 * 255;
                    g = 255;
                    b = (0.66 - intensity) * 3 * 255;
                  } else {
                    r = 255;
                    g = (1 - intensity) * 3 * 255;
                    b = 0;
                  }
                  
                  ctx.fillStyle = `rgba(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)}, ${alpha})`;
                  ctx.fillRect(
                    w*0.15 + col * cellW,
                    h*0.15 + row * cellH,
                    cellW,
                    cellH
                  );
                  
                  // Count text
                  ctx.fillStyle = 'white';
                  ctx.font = 'bold 16px Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'middle';
                  ctx.shadowColor = 'black';
                  ctx.shadowBlur = 2;
                  ctx.fillText(
                    count.toString(),
                    w*0.15 + col * cellW + cellW/2,
                    h*0.15 + row * cellH + cellH/2
                  );
                  ctx.shadowBlur = 0;
                }
              }
            }
            
            // Title
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Strike Zone Heat Map', w/2, 25);
          };
          
          this.debugLog('‚úÖ Heat map system ready', 'success');
        }
        
        updateHeatMap(actionKey, desc) {
          if (actionKey === 'PITCH') {
            const locationMatch = desc?.match(/\[([-\d.]+)\s*,\s*([-\d.]+)\]/);
            if (locationMatch) {
              const x = parseFloat(locationMatch[1]);
              const z = parseFloat(locationMatch[2]);
              
              const col = Math.floor(((x + 0.83) / 1.66) * 3);
              const row = Math.floor(((3.5 - z) / 2.0) * 3);
              
              const gridCol = Math.max(0, Math.min(2, col));
              const gridRow = Math.max(0, Math.min(2, row));
              
              window.heat[gridRow][gridCol]++;
              
              if (window.drawZone) {
                window.drawZone();
              }
              
              this.debugLog(`üìä Heat map: (${x.toFixed(2)}, ${z.toFixed(2)}) ‚Üí [${gridRow}, ${gridCol}] = ${window.heat[gridRow][gridCol]}`);
            }
          }
        }
        
        setupUI() {
          this.debugLog('Setting up clean UI...');
          
          // Mode selection
          document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', () => {
              const mode = card.dataset.mode;
              this.startMode(mode);
            });
          });
          
          // Navigation controls
          document.getElementById('backToMenu')?.addEventListener('click', () => {
            this.backToMenu();
          });
          
          document.getElementById('toggleDebug')?.addEventListener('click', () => {
            this.toggleDebug();
          });
          
          // Set today's date
          const today = new Date().toISOString().split('T')[0];
          const dateInput = document.getElementById('date');
          if (dateInput) dateInput.value = today;
          
          this.debugLog('‚úÖ UI setup complete', 'success');
        }
        
        startMode(mode) {
          this.debugLog(`Starting ${mode} mode`, 'success');
          
          this.currentMode = mode;
          
          // Hide mode selector
          document.getElementById('modeSelector').classList.add('hidden');
          
          // Show game UI
          document.getElementById('gameUI').style.display = 'block';
          
          // Update current mode display
          document.getElementById('currentMode').textContent = 
            mode.charAt(0).toUpperCase() + mode.slice(1) + ' Mode';
          
          // Setup mode-specific controls
          this.setupModeControls(mode);
          
          // Initialize mode
          switch(mode) {
            case 'demo':
              this.initDemoMode();
              break;
            case 'live':
              this.initLiveMode();
              break;
            case 'sandbox':
              controlsContainer.innerHTML = `
                <button id="testPitch">‚öæ Test Pitch</button>
                <button id="testSwing">üèè Test Swing</button>
                <button id="testPhysics">üî¨ Physics Test</button>
                <button class="danger" id="resetAll">üóëÔ∏è Reset All</button>
              `;
              
              // Bind sandbox controls
              document.getElementById('testPitch')?.addEventListener('click', () => this.testPitch());
              document.getElementById('testSwing')?.addEventListener('click', () => this.testSwing());
              document.getElementById('testPhysics')?.addEventListener('click', () => this.testPhysics());
              document.getElementById('resetAll')?.addEventListener('click', () => this.resetAll());
              break;
              
            case 'classic':
              controlsContainer.innerHTML = `
                <button id="btnPitch">Pitch</button>
                <button id="btnAuto">Auto</button>
                <button id="btnReset">Reset</button>
              `;
              
              // Bind classic controls (using original IDs for compatibility)
              document.getElementById('btnPitch')?.addEventListener('click', () => {
                if (window.play && !this.execution.isProcessing) {
                  window.play('PITCH', 'FB 95 [0.0,2.5]');
                }
              });
              
              document.getElementById('btnAuto')?.addEventListener('click', () => this.playDemo());
              document.getElementById('btnReset')?.addEventListener('click', () => this.resetAll());
              break;
          }
        }
        
        // ==========================================
        // MODE IMPLEMENTATIONS
        // ==========================================
        
        initDemoMode() {
          this.debugLog('Demo mode initialized');
          this.demoIndex = 0;
        }
        
        playDemo() {
          if (this.demoInterval) {
            this.debugLog('Demo already running');
            return;
          }
          
          this.debugLog('üé¨ Starting demo playback', 'success');
          this.demoInterval = setInterval(() => {
            this.nextPitch();
          }, 5000); // 5 second intervals for better viewing
        }
        
        pauseDemo() {
          this.debugLog('‚è∏Ô∏è Pausing demo');
          if (this.demoInterval) {
            clearInterval(this.demoInterval);
            this.demoInterval = null;
          }
        }
        
        nextPitch() {
          // Skip if processing
          if (this.execution.isProcessing) {
            this.debugLog('‚ö†Ô∏è Skipping pitch - still processing', 'warning');
            return;
          }
          
          if (this.demoIndex >= this.demoData.length) {
            this.pauseDemo();
            this.debugLog('üé¨ Demo completed, restarting...', 'success');
            this.demoIndex = 0;
            return;
          }
          
          const pitchData = this.demoData[this.demoIndex];
          
          this.debugLog(`üéØ Demo pitch ${this.demoIndex + 1}/${this.demoData.length}: ${pitchData.type} - ${pitchData.desc}`);
          
          // Execute pitch
          if (window.play) {
            window.play(pitchData.type, pitchData.desc);
          }
          
          this.demoIndex++;
        }
        
        resetDemo() {
          this.debugLog('üîÑ Resetting demo');
          this.pauseDemo();
          this.demoIndex = 0;
          this.resetAll();
        }
        
        initLiveMode() {
          this.debugLog('üî¥ Live mode initialized');
        }
        
        loadGames() {
          const dateInput = document.getElementById('date');
          const gameDate = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
          
          this.debugLog(`üìÖ Loading games for ${gameDate}`);
          
          const loadBtn = document.getElementById('load');
          if (loadBtn) {
            loadBtn.click();
            this.debugLog('‚úÖ Triggered game loading', 'success');
          }
        }
        
        connectLive() {
          this.debugLog('üî¥ Connecting to live game');
          
          const connectBtn = document.getElementById('connect');
          if (connectBtn) {
            connectBtn.click();
            this.debugLog('‚úÖ Triggered live connection', 'success');
          }
        }
        
        initSandboxMode() {
          this.debugLog('üõ†Ô∏è Sandbox mode initialized');
        }
        
        testPitch() {
          this.debugLog('üß™ Testing pitch');
          if (window.play && !this.execution.isProcessing) {
            window.play('PITCH', 'TEST 95 [0.0,2.5]');
          }
        }
        
        testSwing() {
          this.debugLog('üß™ Testing swing');
          if (window.play && !this.execution.isProcessing) {
            window.play('SWING', 'Contact [0.2,2.3]');
          }
        }
        
        testPhysics() {
          this.debugLog('üß™ Testing physics');
          if (window.play && !this.execution.isProcessing) {
            window.play('INPLAY', 'Line drive [0.1,2.4]');
          }
        }
        
        initClassicMode() {
          this.debugLog('‚öæ Classic mode initialized');
        }
        
        resetAll() {
          this.debugLog('üîÑ Resetting all systems');
          
          // Reset execution state
          this.execution.isProcessing = false;
          this.execution.lastAction = null;
          
          // Reset demo
          this.pauseDemo();
          this.demoIndex = 0;
          
          // Call original reset if available
          if (window.reset) {
            window.reset();
          }
          
          // Clear heat map
          if (window.heat) {
            window.heat.forEach(row => row.fill(0));
            if (window.drawZone) window.drawZone();
          }
          
          // Reset ball
          const ball = window.gc?.nodes?.ball;
          if (ball) {
            ball.position.set(0, 35, -280);
            ball.userData.v = null;
            ball.visible = true;
          }
          
          this.debugLog('‚úÖ Reset complete', 'success');
        }
        
        backToMenu() {
          this.debugLog('üè† Returning to menu');
          
          this.pauseDemo();
          
          // Hide all game UI
          document.getElementById('gameUI').style.display = 'none';
          document.getElementById('debugPanel').style.display = 'none';
          
          // Show mode selector
          document.getElementById('modeSelector').classList.remove('hidden');
          
          this.currentMode = null;
        }
        
        // ==========================================
        // STATUS UPDATES
        // ==========================================
        
        startStatusUpdates() {
          setInterval(() => {
            this.updateStatusHUD();
          }, 1000);
        }
        
        updateStatusHUD() {
          // Controller status
          document.getElementById('controllerStatus').textContent = this.isReady ? 'Ready' : 'Loading';
          document.getElementById('controllerStatus').className = this.isReady ? 'success' : 'error';
          
          // Ball status
          const ball = window.gc?.nodes?.ball;
          const ballMoving = !!(ball?.userData?.v && ball.userData.v.length() > 0.01);
          document.getElementById('ballStatus').textContent = ballMoving ? 'Flying' : 'Static';
          
          // Execution status
          document.getElementById('executionStatus').textContent = this.execution.isProcessing ? 'Processing' : 'Ready';
          
          // Mode status
          document.getElementById('modeStatus').textContent = this.currentMode || 'Menu';
          
          // System status badge
          const statusBadge = document.getElementById('systemStatus');
          if (statusBadge) {
            if (this.execution.isProcessing) {
              statusBadge.textContent = 'Processing';
              statusBadge.style.backgroundColor = '#f39c12';
            } else if (ballMoving) {
              statusBadge.textContent = 'Ball Flying';
              statusBadge.style.backgroundColor = '#e74c3c';
            } else {
              statusBadge.textContent = 'Ready';
              statusBadge.style.backgroundColor = '#27ae60';
            }
          }
        }
        
        // ==========================================
        // DEBUG SYSTEM
        // ==========================================
        
        debugLog(message, type = 'info') {
          const timestamp = new Date().toLocaleTimeString();
          const logEntry = { time: timestamp, message: message, type: type };
          
          this.debug.logs.push(logEntry);
          
          if (this.debug.logs.length > this.debug.maxLogs) {
            this.debug.logs = this.debug.logs.slice(-this.debug.maxLogs);
          }
          
          const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
          console.log(`[CleanGameController] ${prefix} ${message}`);
          
          if (this.debug.enabled) {
            this.updateDebugPanel();
          }
        }
        
        toggleDebug() {
          this.debug.enabled = !this.debug.enabled;
          const panel = document.getElementById('debugPanel');
          
          if (this.debug.enabled) {
            panel.style.display = 'block';
            this.updateDebugPanel();
            this.debugLog('üêõ Debug panel enabled', 'success');
          } else {
            panel.style.display = 'none';
            this.debugLog('Debug panel disabled');
          }
        }
        
        updateDebugPanel() {
          const content = document.getElementById('debugContent');
          if (!content) return;
          
          let html = '';
          
          // System status
          html += '<div class="debug-row"><strong>SYSTEM STATUS</strong></div>';
          html += `<div class="debug-row ${this.isReady ? 'success' : 'error'}">Controller: ${this.isReady ? 'Ready' : 'Loading'}</div>`;
          html += `<div class="debug-row ${this.systems.gamecast ? 'success' : 'error'}">GameCast: ${this.systems.gamecast ? 'Ready' : 'Missing'}</div>`;
          html += `<div class="debug-row ${window.gc?.nodes?.ball ? 'success' : 'error'}">Ball: ${window.gc?.nodes?.ball ? 'Present' : 'Missing'}</div>`;
          
          // Execution status
          html += '<div class="debug-row"><strong>EXECUTION</strong></div>';
          html += `<div class="debug-row ${this.execution.isProcessing ? 'warning' : 'success'}">Processing: ${this.execution.isProcessing ? 'Yes' : 'No'}</div>`;
          html += `<div class="debug-row">Last Action: ${this.execution.lastAction || 'None'}</div>`;
          html += `<div class="debug-row">Cooldown: ${this.execution.cooldownPeriod}ms</div>`;
          
          // Current mode
          html += '<div class="debug-row"><strong>MODE STATUS</strong></div>';
          html += `<div class="debug-row">Current: ${this.currentMode || 'Menu'}</div>`;
          if (this.currentMode === 'demo') {
            html += `<div class="debug-row">Demo Index: ${this.demoIndex}/${this.demoData.length}</div>`;
            html += `<div class="debug-row">Demo Running: ${!!this.demoInterval}</div>`;
          }
          
          // Ball status
          const ball = window.gc?.nodes?.ball;
          if (ball) {
            html += '<div class="debug-row"><strong>BALL STATUS</strong></div>';
            html += `<div class="debug-row">Position: [${ball.position.x.toFixed(1)}, ${ball.position.y.toFixed(1)}, ${ball.position.z.toFixed(1)}]</div>`;
            html += `<div class="debug-row ${ball.visible ? 'success' : 'error'}">Visible: ${ball.visible}</div>`;
            const isMoving = !!(ball.userData.v && ball.userData.v.length() > 0.01);
            html += `<div class="debug-row ${isMoving ? 'success' : 'error'}">Moving: ${isMoving ? 'Yes' : 'No'}</div>`;
            if (ball.userData.v) {
              html += `<div class="debug-row">Velocity: ${ball.userData.v.length().toFixed(3)}</div>`;
            }
          }
          
          // Heat map
          if (window.heat) {
            const totalPitches = window.heat.flat().reduce((sum, count) => sum + count, 0);
            html += '<div class="debug-row"><strong>HEAT MAP</strong></div>';
            html += `<div class="debug-row">Total Pitches: ${totalPitches}</div>`;
          }
          
          // Recent logs
          html += '<div class="debug-row"><strong>RECENT LOGS</strong></div>';
          const recentLogs = this.debug.logs.slice(-5);
          recentLogs.forEach(log => {
            html += `<div class="debug-row ${log.type}" style="font-size: 10px;">${log.time}: ${log.message}</div>`;
          });
          
          content.innerHTML = html;
        }
        
        debugAll() {
          this.debugLog('=== FULL SYSTEM DEBUG ===');
          this.debugLog(`Controller ready: ${this.isReady}`);
          this.debugLog(`Current mode: ${this.currentMode || 'None'}`);
          this.debugLog(`Execution processing: ${this.execution.isProcessing}`);
          this.debugLog(`Last action: ${this.execution.lastAction || 'None'}`);
          this.debugLog(`Demo running: ${!!this.demoInterval}`);
          
          if (window.gc?.nodes?.ball) {
            const ball = window.gc.nodes.ball;
            this.debugLog(`Ball moving: ${!!(ball.userData.v && ball.userData.v.length() > 0.01)}`);
          }
          
          if (window.heat) {
            const totalPitches = window.heat.flat().reduce((sum, count) => sum + count, 0);
            this.debugLog(`Heat map pitches: ${totalPitches}`);
          }
          
          this.debugLog('=== DEBUG COMPLETE ===');
        }
        
        // Force initialization
        forceInitialize() {
          this.debugLog('üîß Force initialization', 'warning');
          this.systems.gamecast = true;
          
          if (!this.isReady) {
            this.enhanceSystems();
            this.setupUI();
            this.startStatusUpdates();
            this.isReady = true;
            this.debugLog('‚úÖ Force initialized!', 'success');
          }
        }
        
        // Public API
        getStatus() {
          return {
            ready: this.isReady,
            currentMode: this.currentMode,
            systems: this.systems,
            execution: this.execution,
            demoRunning: !!this.demoInterval,
            demoIndex: this.demoIndex
          };
        }
      }
      
      // ==========================================
      // INITIALIZE CONTROLLER
      // ==========================================
      
      let gameController;
      
      window.addEventListener('DOMContentLoaded', () => {
        try {
          gameController = new CleanGameController();
          
          // Global access
          window.gameController = gameController;
          
          // Convenience functions
          window.debugGameCast = () => gameController.debugAll();
          window.testPitch = (velocity = 95, x = 0, z = 2.5) => {
            if (!gameController.execution.isProcessing && window.play) {
              window.play('PITCH', `TEST ${velocity} [${x},${z}]`);
            }
          };
          window.resetGame = () => gameController.resetAll();
          
        } catch (error) {
          console.error('[CleanGameController] Failed to initialize:', error);
        }
      });
      
      window.addEventListener('beforeunload', () => {
        if (gameController) {
          gameController.pauseDemo();
        }
      });
      
    })();
  </script>
</body>
</html>
              this.initSandboxMode();
              break;
            case 'classic':
              this.initClassicMode();
              break;
          }
        }
        
        setupModeControls(mode) {
          const controlsContainer = document.getElementById('modeControls');
          const backendControls = document.getElementById('backendControls');
          
          // Clear existing controls
          controlsContainer.innerHTML = '';
          backendControls.style.display = 'none';
          
          switch(mode) {
            case 'demo':
              controlsContainer.innerHTML = `
                <button class="primary" id="playDemo">‚ñ∂Ô∏è Play Demo</button>
                <button id="pauseDemo">‚è∏Ô∏è Pause</button>
                <button id="nextPitch">‚≠ê Next Pitch</button>
                <button id="resetDemo">üîÑ Reset</button>
              `;
              
              // Bind demo controls
              document.getElementById('playDemo')?.addEventListener('click', () => this.playDemo());
              document.getElementById('pauseDemo')?.addEventListener('click', () => this.pauseDemo());
              document.getElementById('nextPitch')?.addEventListener('click', () => this.nextPitch());
              document.getElementById('resetDemo')?.addEventListener('click', () => this.resetDemo());
              break;
              
            case 'live':
              backendControls.style.display = 'flex';
              controlsContainer.innerHTML = `
                <button class="primary" id="connectLive">üî¥ Connect Live</button>
                <button id="loadGames">üìÖ Load Games</button>
              `;
              
              // Bind live controls
              document.getElementById('connectLive')?.addEventListener('click', () => this.connectLive());
              document.getElementById('loadGames')?.addEventListener('click', () => this.loadGames());
              break;
              
            case